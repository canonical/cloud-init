#!/bin/bash
# This file is part of cloud-init. See LICENSE file for license information.

# This script checks if cloud-init has hotplug hooked and if
# cloud-init has finished; if so invoke cloud-init hotplug-hook

is_finished() {
    [ -e /run/cloud-init/result.json ] || return 1
}

is_enabled() {
    # only execute hooks if cloud-init hotplug enabled and cloud-init
    [ -e /etc/cloud/cloud-init-hook-hotplug ] || return 1
    is_finished
}

if is_enabled; then
    # open cloud-init's hotplug-hook fifo rw
    exec 3<>/run/cloud-init/hook-hotplug-cmd
    case $SUBSYSTEM in
        net)
            ID=$(cat /sys${DEVPATH}/address);;
        block)
            ID=${ID_SERIAL};;
    esac
    env_params=( \
        --id=${ID}
        --devpath=${DEVPATH}
        --subsystem=${SUBSYSTEM}
        --udevaction=${ACTION}
    )
    # write params to cloud-init's hotplug-hook fifo
    echo "--debug ${env_params[@]}" >&3
fi
